{"ast":null,"code":"import _defineProperty from\"/home/radu/Server/src/takserver-tool-ui/node_modules/@babel/runtime/helpers/esm/defineProperty.js\";import _objectSpread from\"/home/radu/Server/src/takserver-tool-ui/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import _slicedToArray from\"/home/radu/Server/src/takserver-tool-ui/node_modules/@babel/runtime/helpers/esm/slicedToArray.js\";import'./FileManager.css';import React,{useEffect}from'react';import{DataGrid,GridToolbarContainer,gridPageSizeSelector,gridFilteredTopLevelRowCountSelector,useGridRootProps,GridPagination,useGridSelector,useGridApiContext,GridCellModes,getGridStringOperators}from'@mui/x-data-grid';import DownloadIcon from'@mui/icons-material/Download';import FileUploadIcon from'@mui/icons-material/FileUpload';import EditIcon from'@mui/icons-material/Edit';import DeleteIcon from'@mui/icons-material/Delete';import SearchIcon from'@mui/icons-material/Search';import FilterAltIcon from'@mui/icons-material/FilterAlt';import CloseIcon from'@mui/icons-material/Close';import{Button,IconButton}from'@mui/material';import TextField from'@mui/material/TextField';import moment from'moment';import Dialog from'@mui/material/Dialog';import DialogActions from'@mui/material/DialogActions';import InputLabel from'@mui/material/InputLabel';import DialogContent from'@mui/material/DialogContent';import DialogContentText from'@mui/material/DialogContentText';import DialogTitle from'@mui/material/DialogTitle';import FormControl from'@mui/material/FormControl';import Typography from'@mui/material/Typography';import UploadFile from'./UploadFile';import{useDropzone}from'react-dropzone';import MenuItem from'@mui/material/MenuItem';import Select from'@mui/material/Select';import Switch from'@mui/material/Switch';import Pagination from'@mui/material/Pagination';import InputAdornment from'@mui/material/InputAdornment';import Footer from'./Footer';import{styled}from\"@mui/material/styles\";import Box from\"@mui/material/Box\";// Reset object needed for componets that access the selected row hook\nimport{jsx as _jsx}from\"react/jsx-runtime\";import{Fragment as _Fragment}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";var emptyRow={name:\"\",hash:\"\"};var StyledGridOverlay=styled(\"div\")(function(_ref){var theme=_ref.theme;return{display:\"flex\",flexDirection:\"column\",alignItems:\"center\",justifyContent:\"center\",height:\"100%\",overflow:\"hidden\",pointerEvents:\"none\",variant:\"contained\",// To make overlay elements interactive\nposition:\"relative\",zIndex:0};});function CustomNoRowsOverlay(){return/*#__PURE__*/_jsx(StyledGridOverlay,{children:/*#__PURE__*/_jsx(Box,{sx:{zIndex:0,pointerEvents:\"none\"},children:\"No Files\"})});}// Structures for missions\nvar allMissions=[];var copMissions=[];var getPageCount=function getPageCount(rowCount,pageSize){if(pageSize>0&&rowCount>0){return Math.ceil(rowCount/pageSize);}return 0;};// Component needed for Delete column rendering\nfunction DeleteButton(_ref2){var setOpen=_ref2.setOpen,row=_ref2.row,setRow=_ref2.setRow,value=_ref2.value;return/*#__PURE__*/_jsx(Button,{variant:\"outlined\",color:\"error\",startIcon:/*#__PURE__*/_jsx(DeleteIcon,{}),onClick:function onClick(e){e.stopPropagation();setRow(row);setOpen(true);},children:value});}// Custom Pagination Controller for Grid\nfunction ActionPagination(_ref3){var _rootProps$rowCount;var page=_ref3.page,onPageChange=_ref3.onPageChange,className=_ref3.className;var apiRef=useGridApiContext();var rootProps=useGridRootProps();var pageSize=useGridSelector(apiRef,gridPageSizeSelector);var _React$useState=React.useState({event:null,value:1}),_React$useState2=_slicedToArray(_React$useState,2),searchPage=_React$useState2[0],setSearchPage=_React$useState2[1];var visibleTopLevelRowCount=useGridSelector(apiRef,gridFilteredTopLevelRowCountSelector);var pageCount=getPageCount((_rootProps$rowCount=rootProps.rowCount)!==null&&_rootProps$rowCount!==void 0?_rootProps$rowCount:visibleTopLevelRowCount,pageSize);useEffect(function(){var delayDebounceFn=setTimeout(function(){onPageChange(searchPage.event,searchPage.value-1);},1000);return function(){return clearTimeout(delayDebounceFn);};},[searchPage]);return/*#__PURE__*/_jsxs(_Fragment,{children:[/*#__PURE__*/_jsx(Typography,{className:className,variant:\"body1\",sx:{ml:5},children:\"Go to Page: \"}),/*#__PURE__*/_jsx(TextField,{size:\"small\",value:searchPage.value,onChange:function onChange(event){setSearchPage({event:event,value:event.target.value});}}),/*#__PURE__*/_jsx(Pagination,{color:\"primary\",className:className,count:pageCount,page:page+1,siblingCount:1,boundaryCount:1,showFirstButton:true,showLastButton:true,onChange:function onChange(event,newPage){onPageChange(event,newPage-1);}})]});}function CustomPagination(props){return/*#__PURE__*/_jsx(GridPagination,_objectSpread({ActionsComponent:ActionPagination},props));}// Custom Toolbar for data grid\nfunction FileManagerToolbar(_ref4){var rowsSelected=_ref4.rowsSelected,setMultiDeleteOpen=_ref4.setMultiDeleteOpen,open=_ref4.open,setFilter=_ref4.setFilter,filterPackage=_ref4.filterPackage,setFilterPackage=_ref4.setFilterPackage,missions=_ref4.missions,setMissions=_ref4.setMissions,mission=_ref4.mission,setMission=_ref4.setMission,copChecked=_ref4.copChecked,setCopChecked=_ref4.setCopChecked,setNameMatch=_ref4.setNameMatch;var _React$useState3=React.useState(\"\"),_React$useState4=_slicedToArray(_React$useState3,2),searchText=_React$useState4[0],setSearchText=_React$useState4[1];return/*#__PURE__*/_jsxs(GridToolbarContainer,{children:[/*#__PURE__*/_jsx(Typography,{variant:\"h5\",className:\"FileManagerLabel\",children:\"File Manager\"}),/*#__PURE__*/_jsx(Button,{className:\"Toolbar\",color:\"error\",startIcon:/*#__PURE__*/_jsx(DeleteIcon,{}),disabled:rowsSelected.length===0,onClick:function onClick(e){setMultiDeleteOpen(true);},children:\"Delete\"}),/*#__PURE__*/_jsxs(Button,{className:\"Toolbar\",color:\"primary\",startIcon:/*#__PURE__*/_jsx(FilterAltIcon,{}),style:{marginRight:16},selected:filterPackage,onClick:function onClick(e){if(!filterPackage){setFilter(\"missionPackage=true\");}else{setFilter(\"\");setMission(\"\");}setFilterPackage(!filterPackage);},children:[filterPackage?\"Remove Filters\":\"Mission Package\",\" \"]}),/*#__PURE__*/_jsx(Typography,{variant:\"body1\",className:\"MissionFilter\",children:\"Mission: \"}),/*#__PURE__*/_jsxs(FormControl,{children:[/*#__PURE__*/_jsx(InputLabel,{id:\"Missions-label\",children:\"Mission Filter\"}),/*#__PURE__*/_jsx(Select,{style:{width:250},value:mission,labelId:\"Missions-label\",label:\"Mission\",onChange:function onChange(e){setMission(e.target.value);setFilter(\"mission=\"+e.target.value);setFilterPackage(true);},children:missions.map(function(m){return/*#__PURE__*/_jsx(MenuItem,{value:m,children:m},m);})})]}),/*#__PURE__*/_jsx(Switch,{checked:copChecked,onChange:function onChange(e){if(e.target.checked===false){setMissions(allMissions);}else{setMissions(copMissions);}setCopChecked(e.target.checked);if(mission!==\"\"){setFilter(\"\");setMission(\"\");setFilterPackage(false);}},inputProps:{'aria-label':'controlled'}}),/*#__PURE__*/_jsx(Typography,{variant:\"body1\",style:{marginRight:16},children:\"Show Only COPs\"}),/*#__PURE__*/_jsx(Button,{className:\"Toolbar\",color:\"primary\",startIcon:/*#__PURE__*/_jsx(FileUploadIcon,{}),style:{marginRight:16},onClick:open,children:\"Upload\"}),/*#__PURE__*/_jsx(TextField,{label:\"Filter By Filename\",value:searchText,onChange:function onChange(event){setSearchText(event.target.value);setNameMatch(\"&name=\"+event.target.value);},InputProps:{endAdornment:/*#__PURE__*/_jsx(InputAdornment,{children:/*#__PURE__*/_jsx(IconButton,{onClick:function onClick(){setSearchText(\"\");setNameMatch(\"\");},children:searchText===\"\"?/*#__PURE__*/_jsx(SearchIcon,{}):/*#__PURE__*/_jsx(CloseIcon,{})})})}})]});}function FileManager(){// Dialog open hooks\nvar _React$useState5=React.useState(false),_React$useState6=_slicedToArray(_React$useState5,2),deleteOpen=_React$useState6[0],setDeleteOpen=_React$useState6[1];var _React$useState7=React.useState(false),_React$useState8=_slicedToArray(_React$useState7,2),multiDeleteOpen=_React$useState8[0],setMultiDeleteOpen=_React$useState8[1];var _React$useState9=React.useState(false),_React$useState10=_slicedToArray(_React$useState9,2),uploadOpen=_React$useState10[0],setUploadOpen=_React$useState10[1];// Selected Row hooks\nvar _React$useState11=React.useState(emptyRow),_React$useState12=_slicedToArray(_React$useState11,2),rowToDelete=_React$useState12[0],setRow=_React$useState12[1];var _React$useState13=React.useState([]),_React$useState14=_slicedToArray(_React$useState13,2),rowsSelected=_React$useState14[0],setRowsSelected=_React$useState14[1];// Fetched data hook\nvar _React$useState15=React.useState([]),_React$useState16=_slicedToArray(_React$useState15,2),rows=_React$useState16[0],setRows=_React$useState16[1];// Hook used to in useEffect to trigger data hydration\nvar _React$useState17=React.useState(false),_React$useState18=_slicedToArray(_React$useState17,2),deleted=_React$useState18[0],setSomethingDeleted=_React$useState18[1];// Pagination system for grid\nvar _React$useState19=React.useState(0),_React$useState20=_slicedToArray(_React$useState19,2),page=_React$useState20[0],setPage=_React$useState20[1];//const [pageSize, setPageSize] = React.useState(12);\nvar _React$useState21=React.useState(100),_React$useState22=_slicedToArray(_React$useState21,2),rowCount=_React$useState22[0],setRowCount=_React$useState22[1];var _React$useState23=React.useState(false),_React$useState24=_slicedToArray(_React$useState23,2),loading=_React$useState24[0],setLoading=_React$useState24[1];var _React$useState25=React.useState({pageSize:12,page:0}),_React$useState26=_slicedToArray(_React$useState25,2),paginationModel=_React$useState26[0],setPaginationModel=_React$useState26[1];// Hooks for filters\nvar _React$useState27=React.useState(\"\"),_React$useState28=_slicedToArray(_React$useState27,2),filter=_React$useState28[0],setFilter=_React$useState28[1];var _React$useState29=React.useState(false),_React$useState30=_slicedToArray(_React$useState29,2),filterPackage=_React$useState30[0],setFilterPackage=_React$useState30[1];var _React$useState31=React.useState(\"\"),_React$useState32=_slicedToArray(_React$useState31,2),nameMatch=_React$useState32[0],setNameMatch=_React$useState32[1];var _React$useState33=React.useState([]),_React$useState34=_slicedToArray(_React$useState33,2),missions=_React$useState34[0],setMissions=_React$useState34[1];var _React$useState35=React.useState([]),_React$useState36=_slicedToArray(_React$useState35,2),mission=_React$useState36[0],setMission=_React$useState36[1];var _React$useState37=React.useState(false),_React$useState38=_slicedToArray(_React$useState37,2),copChecked=_React$useState38[0],setCopChecked=_React$useState38[1];var _React$useState39=React.useState(\"\"),_React$useState40=_slicedToArray(_React$useState39,2),sort=_React$useState40[0],setSort=_React$useState40[1];// Grid Api Ref to make edit button work\nvar _React$useState41=React.useState({}),_React$useState42=_slicedToArray(_React$useState41,2),cellModesModel=_React$useState42[0],setCellModesModel=_React$useState42[1];var handleSortModelChange=function handleSortModelChange(newModel){if(newModel.length===0){setSort(\"\");}else{if(newModel[0].sort===\"asc\"){setSort(\"&sort=\"+newModel[0].field+\"&ascending=true\");}if(newModel[0].sort===\"desc\"){setSort(\"&sort=\"+newModel[0].field+\"&ascending=false\");}}};var handleFilterModelChange=function handleFilterModelChange(newModel){if(newModel.items!==null&&newModel.items.length===0){setNameMatch(\"\");}else{// Model value can be null if set by user\nif(newModel.items[0].value){if(newModel.items[0].field===\"name\"){setNameMatch(\"&name=\"+newModel.items[0].value);}}else{setNameMatch(\"\");}}console.log(nameMatch);};var handleProcessRow=function handleProcessRow(params){var keyword=\"\";if(params.keywords!==\"\"||params.keywords!==\"none\"){keyword=params.keywords;}var data=\"[ \\\"\"+keyword+\"\\\" ]\";console.log(params);var url='/Marti/api/sync/metadata/'+params.hash+'/keywords';console.log(url);fetch(url,{method:'PUT',headers:{'Content-Type':'application/json'},body:data}).then(function(res){if(!res.ok){setSomethingDeleted(!deleted);console.log(res);}});return params;};// Dropzone state management\nvar _React$useState43=React.useState(\"\"),_React$useState44=_slicedToArray(_React$useState43,2),fileProp=_React$useState44[0],setFileProp=_React$useState44[1];var _useDropzone=useDropzone({// Note how this callback is never invoked if drop occurs on the inner dropzone\nnoClick:true,onDrop:function onDrop(files){setFileProp(files[0]);setUploadOpen(true);}}),getRootProps=_useDropzone.getRootProps,getInputProps=_useDropzone.getInputProps,open=_useDropzone.open;// Only get missions once on page load since they cannot be changed on this page\nuseEffect(function(){fetch('/Marti/api/missions').then(function(response){return response.json();}).then(function(data){var missionList=[];data.data.forEach(function(missionData){missionList.push(missionData.name);allMissions.push(missionData.name);if(missionData.tool===\"vbm\"){copMissions.push(missionData.name);}});setMissions(missionList);});},[]);useEffect(function(){setLoading(true);var pageSize=paginationModel.pageSize;var url='/Marti/api/files/metadata?'+filter+'&page='+page+'&limit='+pageSize+sort+nameMatch;// Grab the page first since we start on page 0\nfetch(url).then(function(response){return response.json();}).then(function(data){var rows=[];data.data.forEach(function(rowData,i){var row={id:page*pageSize+i,hash:rowData.Hash,name:rowData.Name,submitter:rowData.User,keywords:rowData.Keywords,groups:rowData.Groups,size:rowData.Size,updateTime:rowData.Time,type:rowData.MimeType,expiration:rowData.Expiration,actions:'Delete'};rows.push(row);});setRows(rows);setLoading(false);});// Get the row count for page indexing\nfetch('/Marti/api/files/metadata/count?'+filter).then(function(response){return response.json();}).then(function(data){setRowCount(data.data);});},[page,deleted,paginationModel,sort,filter,nameMatch]);var stringOperators=getGridStringOperators().filter(function(op){return['contains'].includes(op.value);});// Render definition for Data Grid\nvar columns=[{field:'id',headerName:'ID',width:1},{field:'hash',headerName:'hash',width:1},{field:'name',headerName:'Name',width:330,filterOperators:stringOperators,renderCell:function renderCell(params){return/*#__PURE__*/_jsx(\"div\",{children:/*#__PURE__*/_jsx(Button,{href:'api/files/'+params.row.hash,onClick:function onClick(e){e.stopPropagation();},startIcon:/*#__PURE__*/_jsx(DownloadIcon,{}),\"aria-label\":\"Download\",style:{textTransform:'none'},children:params.value})});}},{field:'submitter',headerName:'Submitter',width:150,sortable:false,filterable:false},{field:'keywords',headerName:'Keywords',width:250,sortable:false,editable:true,filterable:false,cellClassName:'KeywordsCell',renderCell:function renderCell(params){return/*#__PURE__*/_jsx(_Fragment,{children:params.value.length>25?/*#__PURE__*/_jsxs(_Fragment,{children:[params.value.substring(0,25)+\"...\",/*#__PURE__*/_jsx(IconButton//apiRef.current.setCellMode(params.id, params.field, 'edit')\n,{onClick:function onClick(){setCellModesModel(_objectSpread(_objectSpread({},cellModesModel),{},_defineProperty({},params.id,_objectSpread(_objectSpread({},cellModesModel[params.id]),{},_defineProperty({},params.field,{mode:GridCellModes.Edit})))));},children:/*#__PURE__*/_jsx(EditIcon,{})})]}):/*#__PURE__*/_jsxs(_Fragment,{children:[params.value,/*#__PURE__*/_jsx(IconButton//apiRef.current.setCellMode(params.id, params.field, 'edit')\n,{onClick:function onClick(){setCellModesModel(_objectSpread(_objectSpread({},cellModesModel),{},_defineProperty({},params.id,_objectSpread(_objectSpread({},cellModesModel[params.id]),{},_defineProperty({},params.field,{mode:GridCellModes.Edit})))));},children:/*#__PURE__*/_jsx(EditIcon,{})})]})});}},{field:'groups',headerName:'Groups',width:150,sortable:false,filterable:false},{field:'size',headerName:'Size (Approx)',width:120,filterable:false},{field:'updateTime',headerName:'Update Time',width:180,filterable:false,renderCell:function renderCell(params){return/*#__PURE__*/_jsx(TextField,{variant:\"standard\",value:moment(params.value).format(\"YYYY-MM-DDThh:mm\"),InputProps:{disableUnderline:true}});}},{field:'type',headerName:'Type',width:200,sortable:false,filterable:false},{field:'expiration',headerName:'Expiration',width:300,sortable:false,filterable:false,renderCell:function renderCell(params){return/*#__PURE__*/_jsx(TextField,{id:\"datetime-local\",type:\"datetime-local\",defaultValue:moment(params.value).format('YYYY-MM-DDThh:mm'),onClick:function onClick(e){e.stopPropagation();},onChange:function onChange(e){setExpiration(params.row.hash,moment.utc(e.target.value).unix());},InputLabelProps:{shrink:true}});}},{field:'actions',headerName:'Actions',width:150,sortable:false,filterable:false,renderCell:function renderCell(params){return/*#__PURE__*/_jsx(DeleteButton,{setOpen:setDeleteOpen,row:params.row,setRow:setRow,value:params.value});}}];//Used for setting expiration\nfunction setExpiration(hash,newDate){var date;if(isNaN(newDate)){date=-1;}else{date=newDate;}var url='/Marti/api/sync/metadata/'+hash+\"/expiration?expiration=\"+date;fetch(url,{method:'PUT'}).then(function(){setSomethingDeleted(!deleted);});}// Used in Dialog\nvar handleClose=function handleClose(){setDeleteOpen(false);setMultiDeleteOpen(false);setRow(emptyRow);};// Delete functions for row button and toolbar button\nfunction deleteFile(){var url='/Marti/api/files/'+rowToDelete.hash;fetch(url,{method:'DELETE'}).then(function(){setSomethingDeleted(!deleted);handleClose();});}function deleteSelectedFiles(){var urls=[];rowsSelected.forEach(function(rowData){var url='/Marti/api/files/'+rowData.hash;urls.push(url);});Promise.all(urls.map(function(url){return fetch(url,{method:'DELETE'}).then();})).then(function(){setSomethingDeleted(!deleted);handleClose();});}return/*#__PURE__*/_jsxs(\"div\",_objectSpread(_objectSpread({},getRootProps({className:'dropzone'})),{},{children:[/*#__PURE__*/_jsx(\"header\",{className:\"DataTable\",children:/*#__PURE__*/_jsx(DataGrid,{rows:rows,sx:{'.MuiDataGrid-cell--textLeft':{justifyContent:'space-between'},'.MuiDataGrid-overlayWrapper':{zIndex:0}},columns:columns,columnVisibilityModel:{id:false,hash:false},pagination:true//autoPageSize\n,checkboxSelection:true/*onPageSizeChange={(newPageSize) => {\n                console.log(\"New page size: \"+newPageSize)\n                setPageSize(newPageSize)\n            }}*/,pageSizeOptions:[12,25,50,100],page:page,onPageChange:function onPageChange(newPage){return setPage(newPage);},rowCount:rowCount,paginationMode:\"server\",paginationModel:paginationModel,onPaginationModelChange:function onPaginationModelChange(pgModel){setPaginationModel(pgModel);setPage(pgModel.page);},onRowSelectionModelChange:function onRowSelectionModelChange(ids){var selectedRowData=ids.map(function(id){return rows.find(function(row){return row.id===id;});});console.log(selectedRowData);setRowsSelected(selectedRowData);},components:{Toolbar:FileManagerToolbar,Pagination:CustomPagination,noRowsOverlay:CustomNoRowsOverlay,NoResultsOverlay:CustomNoRowsOverlay},componentsProps:{toolbar:{rowsSelected:rowsSelected,setMultiDeleteOpen:setMultiDeleteOpen,open:open,setFilter:setFilter,filterPackage:filterPackage,setFilterPackage:setFilterPackage,missions:missions,setMissions:setMissions,mission:mission,setMission:setMission,copChecked:copChecked,setCopChecked:setCopChecked,setNameMatch:setNameMatch}},rowsSelected:rowsSelected,setMultiDeleteOpen:setMultiDeleteOpen,filterMode:\"server\",onFilterModelChange:handleFilterModelChange,setSomethingDeleted:setSomethingDeleted,deleted:deleted,loading:loading,sortingMode:\"server\",onSortModelChange:handleSortModelChange,disableSelectionOnClick:true,cellModesModel:cellModesModel,onCellModesModelChange:function onCellModesModelChange(model){return setCellModesModel(model);},experimentalFeatures:{newEditingApi:true},processRowUpdate:handleProcessRow,onProcessRowUpdateError:function onProcessRowUpdateError(){}})}),/*#__PURE__*/_jsx(UploadFile,{openHook:uploadOpen,setOpenHook:setUploadOpen,deleted:deleted,setDeleted:setSomethingDeleted,fileProp:fileProp,setFileProp:setFileProp}),/*#__PURE__*/_jsxs(Dialog,{open:deleteOpen,onClose:handleClose,children:[/*#__PURE__*/_jsx(DialogTitle,{id:\"alert-dialog-title\",children:\"Delete File \"+rowToDelete.name+\"?\"}),/*#__PURE__*/_jsx(DialogContent,{children:/*#__PURE__*/_jsx(DialogContentText,{children:\"This file will be removed from the database\"})}),/*#__PURE__*/_jsxs(DialogActions,{children:[/*#__PURE__*/_jsx(Button,{onClick:handleClose,children:\"Cancel\"}),/*#__PURE__*/_jsx(Button,{onClick:deleteFile,autoFocus:true,children:\"Delete\"})]})]}),/*#__PURE__*/_jsxs(Dialog,{open:multiDeleteOpen,onClose:handleClose,children:[/*#__PURE__*/_jsx(DialogTitle,{id:\"alert-dialog-title\",children:\"Delete \"+rowsSelected.length+\" Files ?\"}),/*#__PURE__*/_jsx(DialogContent,{children:/*#__PURE__*/_jsx(DialogContentText,{children:\"The selected files will be removed from the database\"})}),/*#__PURE__*/_jsxs(DialogActions,{children:[/*#__PURE__*/_jsx(Button,{onClick:handleClose,children:\"Cancel\"}),/*#__PURE__*/_jsx(Button,{onClick:deleteSelectedFiles,autoFocus:true,children:\"Delete\"})]})]}),/*#__PURE__*/_jsx(Footer,{})]}));}export default FileManager;","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}